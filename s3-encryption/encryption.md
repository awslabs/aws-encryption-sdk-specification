[//]: # "Copyright Amazon.com Inc. or its affiliates. All Rights Reserved."
[//]: # "SPDX-License-Identifier: CC-BY-SA-4.0"

# Encryption

## Version

0.1.0

### Changelog

- 0.1.0
  - Initial

## Definitions

### Conventions used in this document

The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL"
in this document are to be interpreted as described in [RFC2119](https://tools.ietf.org/html/rfc2119).

## Content Encryption

Once the requisite encryption materials have been provided, the client proceeds to encrypting the plaintext object content.

The client MUST validate that the length of the plaintext bytes does not exceed the algorithm suite's cipher's maximum content length in bytes.
The client MUST generate an IV using the length of the IV defined in the algorithm suite.
The generated IV MUST be set or returned from the encryption process such that it can be included in the content metadata.

### Cipher Initialization

The client SHOULD validate that the generated IV is not zeros.
There is an astoundingly small chance that an IV is generated as all zeros.
An IV containing all zeros is valid, but it is more likely that the IV was not initialized or generated correctly.

The rest of the cipher initialization depends on the algorithm suite:

#### ALG_AES_256_CTR_IV16_TAG16_NO_KDF

Encryption using AES-CTR is not supported.
Attempts to encrypt using AES-CTR MUST fail.

#### ALG_AES_256_CBC_IV16_NO_KDF

TODO: Spec CBC encryption.

#### ALG_AES_256_GCM_IV12_TAG16_NO_KDF

The client MUST initialize the cipher, or call an AES-GCM encryption API, with the plaintext data key, the generated IV, and the tag length defined in the Algorithm Suite when encrypting with ALG_AES_256_GCM_IV12_TAG16_NO_KDF.
The client MUST NOT provide any AAD when encrypting with ALG_AES_256_GCM_IV12_TAG16_NO_KDF.

#### ALG_AES_256_GCM_HKDF_SHA512_COMMIT_KEY

This algorithm suite supports Key Commitment and therefore requires deriving a key commitment value and a derived encryption key.
Using the generated IV as the Message ID, the S3EC MUST use HKDF with the following specifics:

For the extract step:

- The hash function MUST be specified by the algorithm suite commitment settings.
- The input keying material MUST be the plaintext data key (PDK) generated by the key provider.
- The length of the input keying material MUST equal the key derivation input length specified by the algorithm suite commit key derivation setting.
- The salt MUST be the Message ID (or IV) with the length defined in the algorithm suite.

For the expand step:

- For the Derived Encryption Key:
  - The input pseudorandom key MUST be the output from the extract step.
  - The length of the output keying material MUST equal the encryption key length specified by the algorithm suite encryption settings. This will always be 256 bits.
  - The input info MUST be a concatenation of the algorithm suite ID as bytes followed by the string DERIVEKEY as UTF8 encoded bytes.
- For the Commit Key:
  - The input pseudorandom key MUST be the output from the extract step.
  - The length of the output keying material MUST equal the algorithm suite data length specified by the supported algorithm suites. This will always be 224 bits.
  - The input info MUST be a concatenation of the algorithm suite ID as bytes followed by the string COMMITKEY as UTF8 encoded bytes.

The client MUST initialize the cipher, or call an AES-GCM encryption API, with the derived encryption key, an IV containing only zeros, and the tag length defined in the Algorithm Suite when encrypting with ALG_AES_256_GCM_HKDF_SHA512_COMMIT_KEY.
The client MUST set the AAD to the Algorithm Suite ID represented as bytes.
The client MUST append the GCM auth tag to the ciphertext if the underlying crypto provider does not do so automatically.
