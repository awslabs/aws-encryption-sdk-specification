[//]: # "Copyright Amazon.com Inc. or its affiliates. All Rights Reserved."
[//]: # "SPDX-License-Identifier: CC-BY-SA-4.0"

# Key Derivation

## Version

0.1.0

### Changelog

- 0.1.0
  - Initial

## Definitions

### Conventions used in this document

The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL"
in this document are to be interpreted as described in [RFC2119](https://tools.ietf.org/html/rfc2119).

### HKDF Operation

When the algorithm suite is key committing, the S3EC uses HKDF with the following specifics using the generated IV as the Message ID:

For the extract step:

- The hash function MUST be specified by the algorithm suite commitment settings.
- The input keying material MUST be the plaintext data key (PDK) generated by the key provider.
- The length of the input keying material MUST equal the key derivation input length specified by the algorithm suite commit key derivation setting.
- The salt MUST be the Message ID with the length defined in the algorithm suite.

For the expand step:

- For the Derived Encryption Key:
  - The DEK input pseudorandom key MUST be the output from the extract step.
  - The length of the output keying material MUST equal the encryption key length specified by the algorithm suite encryption settings.
  - The input info MUST be a concatenation of the algorithm suite ID as bytes followed by the string DERIVEKEY as UTF8 encoded bytes.
- For the Commit Key:
  - The CK input pseudorandom key MUST be the output from the extract step.
  - The length of the output keying material MUST equal the commit key length specified by the supported algorithm suites.
  - The input info MUST be a concatenation of the algorithm suite ID as bytes followed by the string COMMITKEY as UTF8 encoded bytes.

When encrypting or decrypting with ALG_AES_256_GCM_HKDF_SHA512_COMMIT_KEY,
the IV used in the AES-GCM content encryption/decryption MUST contain only ones of the length defined in the algorithm suite.
The client MUST initialize the cipher, or call an AES-GCM encryption API, with the derived encryption key, an IV containing only ones,
and the tag length defined in the Algorithm Suite when encrypting or decrypting with ALG_AES_256_GCM_HKDF_SHA512_COMMIT_KEY.
This means that the IV would be `[0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01 ]`
The client MUST set the AAD to the Algorithm Suite ID represented as bytes.
