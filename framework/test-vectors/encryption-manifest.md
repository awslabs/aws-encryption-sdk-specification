[//]: # "Copyright Amazon.com Inc. or its affiliates. All Rights Reserved."
[//]: # "SPDX-License-Identifier: CC-BY-SA-4.0"

## Dependencies

This serves as a reference of all features that this feature depends on.

| Feature                                         | Min Version | Max Version |
| ----------------------------------------------- | ----------- | ----------- |
| [keys-description](./key-description.md)        | 2           | n/a         |
| [keys-manifest](./keys-manifest.md)             | 2           | n/a         |
| [encryption-manifest](./encryption-manifest.md) | 2           | n/a         |

## Summary

The encrypt manifest describes static test vectors.
This includes all the necessary details such as keyrings, cmm, encryption context, algorithm suite, etc.

## Out of Scope

This file is not a description of how the test vectors that will be generated by a compatible client should be decrypted.

## Motivation

We need a way of describing all scenarios that we want to cover with test vectors.
This will be used for generating test vectors with an unknown implementation
to be tested for compatibility using a known good implementation.
It will also help us reason about the correctness of specific features or keyrings
by demonstrating that different configurations succeed or fail correctly.

## Guide-level Explanation

This type of manifest describes test vectors to create.
Processing these test scenarios will result in [decryption materials](../structures.md#decryption-materials).

Each test scenario includes all necessary instructions to construct
an [decryption materials request](../cmm-interface.md#decrypt-materials-request).
This includes all necessary inputs including algorithm suite, encryption context, and keyrings/CMMs.

## Reference-level Explanation

### manifest

Map identifying the manifest.

- `type` : Identifies the manifest as an AWS Encryption SDK message encryption manifest.
  - Must be `aws-mpl-decrypt`
- `version` : Identifies the version of this feature document that describes the manifest.

#### keys

URI identifying a [keys manifest](./keys-manifest.md) to use with all tests.

### tests

Map object mapping a test case ID to a test case description
that describes how to generate an [encryption materials request](../cmm-interface.md#encryption-materials-request).
Optional members on [encryption materials request](../cmm-interface.md#encryption-materials-request)
are optional in the test.

- type : The type of test
  - Allowed Values
    - positive-keyring : A successful request for encrypt materials that should also result in a successful decrypt
    - negative-encrypt-keyring: A request for encrypt materials that should fail
    - negative-decrypt-keyring: A successful request for encrypt materials that should result in a failure to decrypt
- description : A human readable decryption of what is being tested
- algorithmSuiteId: : Hex string of supported [Algorithm ID](../algorithm-suites.md#algorithm-suite-id)
- encryptionContext : Map of keys and values to use for encryption context
- requiredEncryptionContextKeys : List of key values that are required to exist in the encryptionContext
- encryptKeyDescription : A [key description](./key-description.md) used to request encrypt materials
  This value will only exist types `positive-keyring` and `negative-decrypt-keyring` because these encrypt materials are expected to succeed
- decryptKeyDescription : The [key description](./key-description.md) used in the decrypt test for this test
- keyDescription : The [key description](./key-description.md) for a `negative-encrypt-keyring`
- reproducedEncryptionContext : The reproducedEncryptionContext to use in the decrypt test for this test
- maxPlaintextLength : The maxPlaintextLength to pass on the [encryption materials request](../cmm-interface.md#encryption-materials-request)
- errorDescription : The description of the expected encrypt error for a `negative-encrypt-keyring` test
- decryptErrorDescription : The description of the expected decrypt error for a `negative-decrypt-keyring` test

### Examples

```json
{
  "tests": {
    "9cb471f7-b33f-4ae9-8e32-7389be33ab1e": {
      "type": "positive-keyring",
      "description": "Discovery KMS MRK us-west-2-mrk->No Filter 0214",
      "algorithmSuiteId": "0214",
      "encryptionContext": {},
      "requiredEncryptionContextKeys": [],
      "encryptKeyDescription": {
        "type": "aws-kms-mrk-aware",
        "key": "us-west-2-mrk"
      },
      "decryptKeyDescription": {
        "type": "aws-kms-mrk-aware-discovery",
        "default-mrk-region": "us-west-2"
      }
    },
    "33e31951-87eb-49c6-ae0b-8d4c11810475": {
      "type": "negative-encrypt-keyring",
      "description": "Encrypt caching failure 0478",
      "errorDescription": "The get or put will fail because the identifier is wrong.",
      "algorithmSuiteId": "0478",
      "encryptionContext": {},
      "requiredEncryptionContextKeys": [],
      "keyDescription": {
        "type": "caching-cmm",
        "underlying": {
          "type": "static-material-keyring",
          "key": "static-cashable-plaintext-data-key"
        },
        "cacheLimitTtlSeconds": 5,
        "getEntryIdentifier": "+m9XmK8rzu0FLMlFmaElNNLcW7Cpp452Tcb/HepBGBbMR2DEfQBRroQbS6jq1acjpjx5hQ9GRKphCCy/ltmHFw==",
        "putEntryIdentifier": ""
      },
      "maxPlaintextLength": 5
    },
    "1d18fd5b-0d34-4fc8-9b35-37f026553760": {
      "type": "negative-decrypt-keyring",
      "description": "Failure of reproducedEncryptionContext 0014",
      "decryptErrorDescription": "The reproducedEncryptionContext is never correct",
      "algorithmSuiteId": "0014",
      "encryptionContext": {
        "a": "a",
        "b": "b"
      },
      "requiredEncryptionContextKeys": [],
      "encryptKeyDescription": {
        "type": "raw",
        "encryption-algorithm": "aes",
        "provider-id": "aws-raw-vectors-persistent-aes-256",
        "key": "aes-256"
      },
      "decryptKeyDescription": {
        "type": "raw",
        "encryption-algorithm": "aes",
        "provider-id": "aws-raw-vectors-persistent-aes-256",
        "key": "aes-256"
      },
      "reproducedEncryptionContext": {
        "a": "a",
        "c": "c"
      }
    }
  }
}
```
